{% extends "base.html" %}

{% block title %}Dashboard - Zekat Monitor{% endblock %}

{% block content %}
    <!-- Page Header -->
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Zakat Dashboard</h2>
        <div class="flex space-x-3">
            <button onclick="runAnalysis()" class="uk-button uk-button-primary">
                Run Analysis Now
            </button>
            <button id="mark-paid-btn" onclick="showMarkPaidModal()" class="hidden uk-button uk-button-secondary">
                Mark Zakat Paid
            </button>
        </div>
    </div>

    <!-- Status Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <!-- Total Assets Card -->
        <div class="uk-card uk-card-default">
            <div class="uk-card-body">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-sm font-medium text-muted-foreground">Total Assets</p>
                        <p class="text-3xl font-bold mt-2" id="total-assets">—</p>
                        <p class="text-xs text-muted-foreground mt-1" id="total-assets-note"></p>
                    </div>
                    <div class="bg-accent/10 rounded-full w-12 h-12 flex items-center justify-center flex-shrink-0 mt-1">
                        <svg class="stat-icon text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Assets Card -->
        <div class="uk-card uk-card-default">
            <div class="uk-card-body">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-sm font-medium text-muted-foreground">Additional Assets</p>
                        <p class="text-3xl font-bold mt-2" id="additional-assets">—</p>
                    </div>
                    <div class="bg-accent/10 rounded-full w-12 h-12 flex items-center justify-center flex-shrink-0 mt-1">
                        <svg class="stat-icon text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nisab Threshold Card -->
        <div class="uk-card uk-card-default">
            <div class="uk-card-body">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-sm font-medium text-muted-foreground">Nisab Threshold</p>
                        <p class="text-3xl font-bold mt-2" id="nisab-threshold">—</p>
                    </div>
                    <div class="bg-accent/10 rounded-full w-12 h-12 flex items-center justify-center flex-shrink-0 mt-1">
                        <svg class="stat-icon text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Source Breakdown -->
    <div id="sources-section" class="hidden mb-6">
        <h3 class="text-lg font-semibold mb-4">Account Sources</h3>
        <div id="sources-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Source cards inserted dynamically -->
        </div>
    </div>

    <!-- Hijri Year Progress -->
    <div class="uk-card uk-card-default mb-6">
        <div class="uk-card-body">
            <h3 class="text-lg font-semibold mb-4">Hijri Year Progress</h3>
            <div class="space-y-3">
                <div class="flex justify-between text-sm">
                    <span class="text-muted-foreground">Consecutive Months Above Nisab</span>
                    <span class="font-medium" id="consecutive-months">— / 12 months</span>
                </div>
                <progress class="uk-progress" value="0" max="100" id="hijri-progress-bar"></progress>
                <div id="year-progress-source" class="text-xs text-muted-foreground mt-1"></div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="uk-card uk-card-default mb-6">
        <div class="uk-card-body">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Recent Activity</h3>
                <svg class="w-5 h-5 text-muted-foreground" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <div id="recent-activity">
                <div class="text-center py-6 text-muted-foreground">
                    <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p class="text-sm">Enter your master password to load dashboard data.</p>
                </div>
            </div>
        </div>
    </div>

<!-- Password Modal -->
<div id="password-modal" data-uk-modal>
    <div class="uk-modal-dialog uk-modal-body">
        <h2 class="uk-modal-title mb-4">Enter Master Password</h2>
        <form id="password-form" class="space-y-4">
            <div>
                <input type="password" id="master-password" required placeholder="Master password" class="uk-input">
            </div>
            <div class="flex justify-end">
                <button type="submit" class="uk-button uk-button-primary">
                    Load Dashboard
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Mark Paid Modal -->
<div id="mark-paid-modal" data-uk-modal>
    <div class="uk-modal-dialog uk-modal-body">
        <h2 class="uk-modal-title mb-4">Mark Zakat as Paid</h2>
        <form id="mark-paid-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-1">Master Password</label>
                <input type="password" id="mark-paid-password" required class="uk-input">
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Amount (BAM)</label>
                <input type="number" id="mark-paid-amount" step="0.01" min="0.01" required class="uk-input">
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Hijri Date (DD/MM/YYYY)</label>
                <input type="text" id="mark-paid-date" placeholder="01/01/1446" required class="uk-input">
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="hideMarkPaidModal()" class="uk-button uk-button-default">
                    Cancel
                </button>
                <button type="submit" class="uk-button uk-button-secondary">
                    Confirm Payment
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // Try cached password on load
    window.addEventListener('DOMContentLoaded', function() {
        const cached = getStoredPassword();
        if (cached) {
            loadDashboard(cached);
        } else {
            UIkit.modal('#password-modal').show();
        }
    });

    document.getElementById('password-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const password = document.getElementById('master-password').value;
        loadDashboard(password);
    });

    function loadDashboard(password) {
        const params = new URLSearchParams({ master_password: password });

        fetch(`/api/settings/full?${params}`)
            .then(response => response.json())
            .then(resp => {
                if (resp.success) {
                    storePassword(password);
                    UIkit.modal('#password-modal').hide();
                    populateDashboard(resp.data);
                } else {
                    throw new Error(resp.detail || 'Failed to load settings');
                }
            })
            .catch(error => {
                // If cached password expired/wrong, show modal
                clearStoredPassword();
                UIkit.modal('#password-modal').show();
                showNotification(error.message, 'error');
            });
    }

    function populateDashboard(settings) {
        // Additional Assets
        const additionalAssets = settings.additional_assets || 0;
        document.getElementById('additional-assets').textContent =
            additionalAssets.toFixed(2) + ' BAM';

        // Total Assets (additional only until analysis runs)
        document.getElementById('total-assets').textContent =
            additionalAssets.toFixed(2) + ' BAM';
        document.getElementById('total-assets-note').textContent =
            'Additional assets only. Run analysis for full total.';

        // Nisab Fallback
        const nisabFallback = settings.nisab_fallback_bam || 24624.0;
        document.getElementById('nisab-threshold').textContent =
            nisabFallback.toFixed(2) + ' BAM';

        // Year Progress Override
        const override = settings.year_progress_override;
        if (override && override.enabled) {
            const months = override.months_above_nisab || 0;
            document.getElementById('consecutive-months').textContent = months + ' / 12 months';
            document.getElementById('hijri-progress-bar').value = (months / 12) * 100;
            document.getElementById('year-progress-source').textContent =
                'From year progress override (as of ' + override.as_of_hijri_date + ')';
        } else {
            document.getElementById('consecutive-months').textContent = '0 / 12 months';
            document.getElementById('hijri-progress-bar').value = 0;
            document.getElementById('year-progress-source').textContent =
                'No year progress override set. Run analysis to track automatically.';
        }

        // Show source cards from config
        populateSourceCards(settings.email_sources || []);

        // Try to load last analysis result for balances
        loadLastAnalysisResult(settings);

        // Recent activity
        const activityDiv = document.getElementById('recent-activity');
        activityDiv.textContent = '';
        const p = document.createElement('div');
        p.className = 'text-center py-4 text-muted-foreground';
        p.textContent = 'Run an analysis to see recent activity.';
        activityDiv.appendChild(p);
    }

    function populateSourceCards(emailSources) {
        const section = document.getElementById('sources-section');
        const container = document.getElementById('sources-container');
        container.textContent = '';

        if (emailSources.length === 0) return;
        section.classList.remove('hidden');

        emailSources.forEach((source, index) => {
            const card = document.createElement('div');
            card.className = 'uk-card uk-card-default source-card';
            card.id = 'source-card-' + index;

            const cardBody = document.createElement('div');
            cardBody.className = 'uk-card-body';

            const header = document.createElement('div');
            header.className = 'flex items-center justify-between gap-3 mb-3';

            const labelContainer = document.createElement('div');
            labelContainer.className = 'flex items-center gap-2';

            const labelIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            labelIcon.setAttribute('class', 'w-4 h-4 text-accent');
            labelIcon.setAttribute('fill', 'none');
            labelIcon.setAttribute('viewBox', '0 0 24 24');
            labelIcon.setAttribute('stroke', 'currentColor');
            labelIcon.setAttribute('stroke-width', '2');
            const labelIconPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            labelIconPath.setAttribute('stroke-linecap', 'round');
            labelIconPath.setAttribute('stroke-linejoin', 'round');
            labelIconPath.setAttribute('d', 'M3 19v-8.93a2 2 0 01.89-1.664l7-4.666a2 2 0 012.22 0l7 4.666A2 2 0 0121 10.07V19M3 19a2 2 0 002 2h14a2 2 0 002-2M3 19l6.75-4.5M21 19l-6.75-4.5M3 10l6.75 4.5M21 10l-6.75 4.5m0 0l-1.14.76a2 2 0 01-2.22 0l-1.14-.76');
            labelIcon.appendChild(labelIconPath);

            const label = document.createElement('h4');
            label.className = 'text-sm font-semibold';
            label.textContent = source.label || 'Source ' + (index + 1);

            labelContainer.appendChild(labelIcon);
            labelContainer.appendChild(label);

            const emailBadge = document.createElement('span');
            emailBadge.className = 'text-xs text-muted-foreground bg-muted px-3 py-1 rounded';
            emailBadge.textContent = source.email;

            header.appendChild(labelContainer);
            header.appendChild(emailBadge);
            cardBody.appendChild(header);

            const pairs = source.account_pairs || [];
            pairs.forEach(pair => {
                const pairDiv = document.createElement('div');
                pairDiv.className = 'flex justify-between items-center py-2 border-t border-divider-dark';

                const accountsDiv = document.createElement('div');
                accountsDiv.className = 'text-xs text-muted-foreground';
                accountsDiv.textContent = 'BAM: ' + pair.bam_account + ' / EUR: ' + pair.eur_account;

                const balanceDiv = document.createElement('div');
                balanceDiv.className = 'text-right source-balance';
                balanceDiv.setAttribute('data-source-index', index);

                const pendingP = document.createElement('p');
                pendingP.className = 'text-xs text-muted-foreground italic';
                pendingP.textContent = 'Run analysis for balances';
                balanceDiv.appendChild(pendingP);

                pairDiv.appendChild(accountsDiv);
                pairDiv.appendChild(balanceDiv);
                cardBody.appendChild(pairDiv);
            });

            // Source total row
            const totalDiv = document.createElement('div');
            totalDiv.className = 'flex justify-between items-center pt-3 mt-1 border-t-2 border-divider-dark';
            totalDiv.id = 'source-total-' + index;

            const totalLabel = document.createElement('span');
            totalLabel.className = 'text-sm font-medium';
            totalLabel.textContent = 'Source Total';

            const totalValue = document.createElement('span');
            totalValue.className = 'text-sm font-bold';
            totalValue.textContent = '—';

            totalDiv.appendChild(totalLabel);
            totalDiv.appendChild(totalValue);
            cardBody.appendChild(totalDiv);

            card.appendChild(cardBody);
            container.appendChild(card);
        });
    }

    function loadLastAnalysisResult(settings) {
        fetch('/api/analyze/result')
            .then(r => r.json())
            .then(data => {
                if (data.success && data.data) {
                    applyAnalysisResult(data.data, settings);
                }
            })
            .catch(() => {});
    }

    function applyAnalysisResult(result, settings) {
        // Update top-level cards
        const totalAssets = result.total_assets || 0;
        document.getElementById('total-assets').textContent = totalAssets.toFixed(2) + ' BAM';
        document.getElementById('total-assets-note').textContent =
            'Bank: ' + (result.bank_balance || 0).toFixed(2) + ' + Additional: ' + (result.additional_assets || 0).toFixed(2);

        if (result.nisab_threshold) {
            document.getElementById('nisab-threshold').textContent =
                result.nisab_threshold.toFixed(2) + ' BAM';
        }

        // Update year progress from analysis
        const months = result.consecutive_months_above_nisab || 0;
        document.getElementById('consecutive-months').textContent = months + ' / 12 months';
        document.getElementById('hijri-progress-bar').value = (months / 12) * 100;
        document.getElementById('year-progress-source').textContent = 'From last analysis';

        // Show "Mark Zakat Paid" button only when 12-month threshold is met
        const markPaidBtn = document.getElementById('mark-paid-btn');
        if (months >= 12) {
            markPaidBtn.classList.remove('hidden');
        } else {
            markPaidBtn.classList.add('hidden');
        }

        // Populate recent activity
        updateRecentActivity(result);

        // Update source cards with balances
        const sources = result.sources || [];
        sources.forEach((src, index) => {
            const card = document.getElementById('source-card-' + index);
            if (!card) return;

            // Replace the pending balance text with actual values
            const balanceDivs = card.querySelectorAll('.source-balance');
            if (balanceDivs.length > 0) {
                const balanceDiv = balanceDivs[0];
                balanceDiv.textContent = '';

                const bamP = document.createElement('p');
                bamP.className = 'text-sm font-medium';
                bamP.textContent = (src.bam_balance || 0).toFixed(2) + ' BAM';

                const eurP = document.createElement('p');
                eurP.className = 'text-xs text-muted-foreground';
                eurP.textContent = (src.eur_balance || 0).toFixed(2) + ' EUR';

                balanceDiv.appendChild(bamP);
                balanceDiv.appendChild(eurP);
            }

            // Update source total
            const totalDiv = document.getElementById('source-total-' + index);
            if (totalDiv) {
                const totalValue = totalDiv.querySelector('.font-bold');
                if (totalValue) {
                    totalValue.textContent = (src.total_bam || 0).toFixed(2) + ' BAM';
                }
            }
        });
    }

    function runAnalysis() {
        const password = getStoredPassword() || prompt('Enter your master password:');
        if (!password) return;

        fetch('/api/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ master_password: password })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Analysis started! Check the Analysis page for progress.', 'success');
                setTimeout(() => window.location.href = '/analysis', 1500);
            } else {
                throw new Error(data.message || 'Failed to start analysis');
            }
        })
        .catch(error => {
            showNotification(error.message, 'error');
        });
    }

    function updateRecentActivity(result) {
        const activityDiv = document.getElementById('recent-activity');
        activityDiv.textContent = '';

        const items = [];

        // Last analysis summary
        if (result.total_assets) {
            items.push({
                status: 'info',
                text: 'Analysis completed - Total assets: ' + result.total_assets.toFixed(2) + ' BAM',
                time: 'Just now'
            });
        }
        if (result.above_nisab !== undefined) {
            items.push({
                status: result.above_nisab ? 'success' : 'warning',
                text: result.above_nisab ? 'Balance is above nisab threshold' : 'Balance is below nisab threshold',
                time: 'Just now'
            });
        }
        const months = result.consecutive_months_above_nisab || 0;
        items.push({
            status: months >= 12 ? 'success' : 'warning',
            text: months >= 12
                ? 'Zakat is due! 12-month threshold reached.'
                : 'Year progress: ' + months + ' of 12 consecutive months above nisab',
            time: 'Just now'
        });

        // Per-source breakdown
        const sources = result.sources || [];
        sources.forEach(src => {
            const name = src.source_name || 'Source';
            const total = (src.bam_balance_in_bam || 0) + (src.eur_balance_in_bam || 0);
            items.push({
                status: 'neutral',
                text: name + ': ' + total.toFixed(2) + ' BAM',
                time: 'Just now'
            });
        });

        if (items.length === 0) {
            const emptyState = document.createElement('div');
            emptyState.className = 'text-center py-6 text-muted-foreground';

            const iconSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            iconSvg.setAttribute('class', 'w-12 h-12 mx-auto mb-3 opacity-50');
            iconSvg.setAttribute('fill', 'none');
            iconSvg.setAttribute('viewBox', '0 0 24 24');
            iconSvg.setAttribute('stroke', 'currentColor');
            iconSvg.setAttribute('stroke-width', '1.5');
            const iconPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            iconPath.setAttribute('stroke-linecap', 'round');
            iconPath.setAttribute('stroke-linejoin', 'round');
            iconPath.setAttribute('d', 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z');
            iconSvg.appendChild(iconPath);

            const p = document.createElement('p');
            p.className = 'text-sm';
            p.textContent = 'Run an analysis to see recent activity.';

            emptyState.appendChild(iconSvg);
            emptyState.appendChild(p);
            activityDiv.appendChild(emptyState);
            return;
        }

        const ul = document.createElement('ul');
        ul.className = 'divide-y divide-divider-dark';
        items.forEach(item => {
            const li = document.createElement('li');
            li.className = 'py-3 flex items-start gap-3';

            const dot = document.createElement('span');
            dot.className = 'activity-dot status-' + item.status;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'flex-1';

            const textSpan = document.createElement('span');
            textSpan.className = 'text-sm block';
            textSpan.textContent = item.text;

            const timeSpan = document.createElement('span');
            timeSpan.className = 'text-xs text-muted-foreground mt-0.5 block';
            timeSpan.textContent = item.time;

            contentDiv.appendChild(textSpan);
            contentDiv.appendChild(timeSpan);

            li.appendChild(dot);
            li.appendChild(contentDiv);
            ul.appendChild(li);
        });
        activityDiv.appendChild(ul);
    }

    function showMarkPaidModal() {
        UIkit.modal('#mark-paid-modal').show();
        const cached = getStoredPassword();
        if (cached) {
            document.getElementById('mark-paid-password').value = cached;
        }
    }

    function hideMarkPaidModal() {
        UIkit.modal('#mark-paid-modal').hide();
    }

    document.getElementById('mark-paid-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const payload = {
            master_password: document.getElementById('mark-paid-password').value,
            amount: parseFloat(document.getElementById('mark-paid-amount').value),
            hijri_date: document.getElementById('mark-paid-date').value
        };

        fetch('/api/mark-paid', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                hideMarkPaidModal();
                showNotification('Zakat payment recorded successfully!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                throw new Error(data.message || 'Failed to record payment');
            }
        })
        .catch(error => {
            showNotification(error.message, 'error');
        });
    });
</script>
{% endblock %}
