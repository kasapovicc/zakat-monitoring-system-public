# Example GitHub Actions workflow for building Zekat.app
#
# To use:
# 1. Rename to build-app.yml (remove .example)
# 2. Push to enable automatic builds
#
# This workflow:
# - Builds on macOS runner
# - Creates Zekat.app bundle
# - Uploads as release artifact

name: Build macOS App

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v0.1.0
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-app.txt
          pip install pyinstaller

      - name: Build app
        run: |
          python build.py

      - name: Create distributable archive
        run: |
          cd dist
          zip -r Zekat.zip Zekat.app

      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=dev-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: Zekat-${{ steps.get_version.outputs.VERSION }}
          path: dist/Zekat.zip

      - name: Create Release (on tag)
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v1
        with:
          files: dist/Zekat.zip
          body: |
            ## Zekat Monitor ${{ steps.get_version.outputs.VERSION }}

            ### Installation

            1. Download `Zekat.zip`
            2. Extract and move to Applications:
               ```bash
               unzip Zekat.zip
               mv Zekat.app /Applications/
               ```
            3. Bypass Gatekeeper (one-time):
               ```bash
               xattr -cr /Applications/Zekat.app
               open /Applications/Zekat.app
               ```

            See [DISTRIBUTION.md](DISTRIBUTION.md) for full instructions.

            ### System Requirements

            - macOS 10.13 or later
            - ~150 MB disk space

            ### What's New

            - Initial release
            - Automated zakat monitoring
            - macOS menubar integration
            - Encrypted local storage

            **Note:** This is an unsigned app. The Gatekeeper bypass is safe and required for unsigned apps.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
